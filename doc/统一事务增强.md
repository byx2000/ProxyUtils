# 统一事务增强

`UserDao`接口定义如下：

```java
public interface UserDao
{
    List<User> listAll();
    void delete(int id);
    void insert(User user);
}
```

`UserDaoImpl`实现类：

```java
public class UserDaoImpl implements UserDao
{
    @Override
    public List<User> listAll()
    {
        System.out.println("正在执行listAll方法");
        return new ArrayList<>();
    }

    @Override
    public void delete(int id)
    {
        System.out.println("正在执行delete方法");
    }

    @Override
    public void insert(User user)
    {
        System.out.println("正在执行insert方法");
        throw new RuntimeException();
    }
}
```

在`UserDaoImpl`中，所有以`list`开头的方法都是数据库查询操作，如`listAll`，其余方法都是数据库更新操作，如`delete`和`insert`。 其中，`delete`方法正常执行（模拟事务正常提交），`insert`方法内部抛出了异常（模拟事务回滚）。

假设现在要为所有涉及到数据库更新的方法添加事务控制：

```java
// 事务增强拦截器
MethodInterceptor transactionEnhance = (signature, targetMethod, params) ->
{
    System.out.println("开启事务");
    try
    {
        Object ret = targetMethod.invoke(params);
        System.out.println("提交事务");
        return ret;
    }
    catch (TargetMethodException e)
    {
        System.out.println("发生异常");
        System.out.println("回滚事务");
        return null;
    }
};

// 匹配所有不以list开头的方法
MethodMatcher updateMethods = withPattern("list(.*)").not();

// 创建事务增强的UserDaoImpl
UserDao userDao = proxy(new UserDaoImpl(), transactionEnhance.when(updateMethods));

userDao.listAll();
System.out.println();
userDao.delete(1001);
System.out.println();
userDao.insert(new User());
```

运行上面的代码，控制台输出如下：

```
正在执行listAll方法

开启事务
正在执行delete方法
提交事务

开启事务
正在执行insert方法
发生异常
回滚事务
```